<script>
const DEVELOPER_KEY = "AIzaSyCkaT7Pa3GghLtBnGcli47UpuAkHcUfp7Q";
const DIALOG_DIMENSIONS = {width: 600, height: 425};
var /* global */ pickerApiLoaded = false;

/**
 * Loads the Google Picker API.
 */
function onApiLoad() {
  gapi.load('picker', {'callback': function() {
    pickerApiLoaded = true;
    Array.from(document.querySelectorAll('.creates-picker')).forEach(button => {
      button.removeAttribute('disabled');
    });
  }});
}

/**
 * Gets the user's OAuth 2.0 access token from the server-side script so that
 * it can be passed to Picker. This technique keeps Picker from needing to
 * show its own authorization dialog, but is only possible if the OAuth scope
 * that Picker needs is available in Apps Script. Otherwise, your Picker code
 * will need to declare its own OAuth scopes.
 *
 * This should be attached to a button for user to "Select a file"
 */
function getOAuthToken(click) {
  const view = click.target.value == "select-sheet" ?
    google.picker.ViewId.SPREADSHEETS :
    google.picker.ViewId.DOCUMENTS;
  google.script.run.withSuccessHandler(createPicker)
      .withFailureHandler(showError).getOAuthToken(view);
}

/**
 * Creates a Picker that can access the user's spreadsheets. This function
 * uses advanced options to hide the Picker's left navigation panel and
 * default title bar.
 *
 * @param {string} token An OAuth 2.0 access token that lets Picker access the
 *     file type specified in the addView call.
 */
function createPicker({token, view}) {
  if (! pickerApiLoaded || ! token) {
    showError('Unable to load the file picker.');
  } 
  const picker = new google.picker.PickerBuilder()
      // Instruct Picker to display only spreadsheets in Drive. For other
      // views, see https://developers.google.com/picker/docs/#otherviews
      .addView(view) //google.picker.ViewId.SPREADSHEETS
      // Hide the navigation panel so that Picker fills more of the dialog.
      .enableFeature(google.picker.Feature.NAV_HIDDEN)
      // Hide the title bar since an Apps Script dialog already has a title.
      .hideTitleBar()
      .setOAuthToken(token)
      .setDeveloperKey(DEVELOPER_KEY)
      .setCallback(pickerCallback)
      .setOrigin(google.script.host.origin)
      // Instruct Picker to fill the dialog, minus 2 pixels for the border.
      .setSize(DIALOG_DIMENSIONS.width - 2,
          DIALOG_DIMENSIONS.height - 2)
      .build();
  picker.setVisible(true);
}

/**
 * A callback function that extracts the chosen document's metadata from the
 * response object. For details on the response object, see
 * https://developers.google.com/picker/docs/result
 * 
 * @param {object} data The response object.
 */
function pickerCallback(data) {
  if (data[google.picker.Response.ACTION] != google.picker.Action.PICKED) {
    return;
  }
  const view = data[google.picker.Response.VIEW][google.picker.ViewToken.VIEW_ID];
  const containerId = view == google.picker.ViewId.SPREADSHEETS ?
    "selected-spreadsheet" :
    "selected-template";
  const container = document.querySelector('#' + containerId);
  const doc = data[google.picker.Response.DOCUMENTS][0];
  const configKey = view == google.picker.ViewId.SPREADSHEETS ?
    "SPREADSHEET_ID" :
    "TEMPLATE_ID";
  config[configKey] = doc[google.picker.Document.ID];
  const url = doc[google.picker.Document.URL];
  const name = doc[google.picker.Document.NAME];
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.textContent = name;
  const link_container = container.querySelector('.doc-link');
  while (link_container.firstChild) link_container.firstChild.remove();
  link_container.appendChild(link);
  if (view == google.picker.ViewId.SPREADSHEETS) {
    google.script.run
      .withSuccessHandler(populateSheetNameSelect)
      .withFailureHandler(showError)
      .withUserObject(link_container)
      .getSheetNames(doc[google.picker.Document.ID]);
  }
}

/**
 * Displays an error message within the container supplied by run.withUserObject(container)
 *
 * @param {string} message The error message to display.
 */
function showError(message, container) {
  container.innerHTML = 'Error: ' + message;
}
</script>